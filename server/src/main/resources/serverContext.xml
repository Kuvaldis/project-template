<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <import resource="classpath*:coreContext.xml"/>
    <import resource="classpath*:restContext.xml"/>
    <import resource="classpath:securityContext.xml"/>

    <context:annotation-config/>
    <context:component-scan base-package="kuvaldis.server"/>

    <bean id="propertiesHolder" factory-bean="propertiesBuilder" factory-method="build">
        <constructor-arg value="config/server-config.groovy"/>
        <constructor-arg value="config/server-profiles-config.groovy"/>
        <constructor-arg value="config/server-dev-config.groovy"/>
    </bean>

    <bean id="props" class="kuvaldis.server.config.MultiConfigPropertiesFactoryBean" depends-on="propertiesHolder">
        <constructor-arg name="propertiesHolder" ref="propertiesHolder"/>
    </bean>

    <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer" depends-on="props">
        <property name="properties" ref="props"/>
    </bean>

    <!--servlet handler-->
    <bean id="servletHandler" class="org.eclipse.jetty.servlet.ServletHandler">
        <property name="filters">
            <list>
                <bean id="springSecurityFilterChain" class="org.eclipse.jetty.servlet.FilterHolder">
                    <property name="className" value="org.springframework.web.filter.DelegatingFilterProxy"/>
                    <property name="name" value="springSecurityFilterChain"/>
                </bean>
                <bean class="org.eclipse.jetty.servlet.FilterHolder">
                    <property name="className" value="org.springframework.web.filter.CharacterEncodingFilter"/>
                    <property name="name" value="encodingFilter"/>
                    <property name="initParameters">
                        <map>
                            <entry key="encoding" value="UTF-8"/>
                            <entry key="forceEncoding" value="true"/>
                        </map>
                    </property>
                </bean>
            </list>
        </property>
        <property name="filterMappings">
            <list>
                <bean class="org.eclipse.jetty.servlet.FilterMapping">
                    <property name="filterName" value="springSecurityFilterChain"/>
                    <property name="dispatcherTypes" value="#{T(java.util.EnumSet).allOf(T(javax.servlet.DispatcherType))}"/>
                    <property name="pathSpec" value="/*"/>
                </bean>
                <bean class="org.eclipse.jetty.servlet.FilterMapping">
                    <property name="filterName" value="encodingFilter"/>
                    <property name="dispatcherTypes" value="#{T(java.util.EnumSet).allOf(T(javax.servlet.DispatcherType))}"/>
                    <property name="pathSpec" value="/*"/>
                </bean>
            </list>
        </property>
        <property name="servlets">
            <list>
                <bean class="org.eclipse.jetty.servlet.ServletHolder">
                    <constructor-arg name="name" value="rest-api"/>
                    <constructor-arg name="servlet">
                        <bean class="org.glassfish.jersey.servlet.ServletContainer">
                            <constructor-arg name="resourceConfig">
                                <bean class="kuvaldis.rest.RestConfig">
                                    <constructor-arg name="packages" value="kuvaldis.rest.resource"/>
                                </bean>
                            </constructor-arg>
                        </bean>
                    </constructor-arg>
                </bean>
            </list>
        </property>
        <property name="servletMappings">
            <list>
                <bean class="org.eclipse.jetty.servlet.ServletMapping">
                    <property name="servletName" value="rest-api"/>
                    <property name="pathSpec" value="/api/v1/*"/>
                </bean>
            </list>
        </property>
    </bean>

    <bean id="servletContextHandler" class="org.eclipse.jetty.servlet.ServletContextHandler">
        <property name="eventListeners">
            <list>
                <bean class="kuvaldis.server.context.CurrentContextAwareContextLoaderListener"/>
            </list>
        </property>
        <property name="servletHandler" ref="servletHandler"/>
    </bean>

    <!--server-->
    <bean id="server" class="org.eclipse.jetty.server.Server">
        <constructor-arg name="port" value="${server.port}"/>
        <property name="handler">
            <bean class="org.eclipse.jetty.server.handler.ContextHandlerCollection">
                <property name="handlers">
                    <list>
                        <ref bean="servletContextHandler"/>
                    </list>
                </property>
            </bean>
        </property>
    </bean>
</beans>